<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Trips</title>
  <link rel="stylesheet" href="/static/app.css" />
</head>
<body>
  <div class="container">
    {% include "_nav.html" %}
    <h2>Trips</h2>

    <div class="card">
      <div class="row">
        <input id="origin" placeholder="Origin" />
        <input id="destination" placeholder="Destination" />
        <input id="date" placeholder="YYYY-MM-DD" />
        <button id="searchBtn">Search</button>
        <button class="secondary" id="resetBtn">Reset</button>
      </div>
      <div id="msg" class="error"></div>
    </div>

    <div id="list"></div>
  </div>

  <script src="/static/app.js"></script>
  <script>
    requireAuthOrRedirect();

    async function loadTrips(params = {}) {
      const msg = document.getElementById("msg");
      const list = document.getElementById("list");
      msg.textContent = "";
      list.innerHTML = "";

      try {
        const data = await fetchTrips({ page: 1, page_size: 10, ...params });
        data.items.forEach(t => {
          const div = document.createElement("div");
          div.className = "card";
          div.innerHTML = `
            <div class="row">
              <div style="flex:1;">
                <div><b>${t.origin}</b> â†’ <b>${t.destination}</b></div>
                <small>Departure: ${t.departure_time}</small><br/>
                <small>Price: ${t.price} | Seats: ${t.available_seats}/${t.total_seats}</small>
              </div>
              <div>
                <span class="badge">${t.status}</span><br/><br/>
                <button onclick="location.href='/trips/${t.trip_id}/'">View</button>
              </div>
            </div>
          `;
          list.appendChild(div);
        });
      } catch (e) {
        msg.textContent = `${e.code}: ${e.message}`;
        if (e.status === 401) logout();
      }
    }

    document.getElementById("searchBtn").addEventListener("click", () => {
      const origin = document.getElementById("origin").value.trim();
      const destination = document.getElementById("destination").value.trim();
      const date = document.getElementById("date").value.trim();
      const params = {};
      if (origin) params.origin = origin;
      if (destination) params.destination = destination;
      if (date) params.date = date;
      loadTrips(params);
    });

    document.getElementById("resetBtn").addEventListener("click", () => {
      document.getElementById("origin").value = "";
      document.getElementById("destination").value = "";
      document.getElementById("date").value = "";
      loadTrips();
    });

    loadTrips();
  </script>
</body>
</html>