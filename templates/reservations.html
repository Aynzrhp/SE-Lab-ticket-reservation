<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>My Reservations</title>
  <link rel="stylesheet" href="/static/app.css" />
</head>
<body>
  <div class="container">
    {% include "_nav.html" %}
    <h2>My Reservations</h2>

    <div class="card">
      <div class="row">
        <select id="status">
          <option value="">All</option>
          <option value="active">active</option>
          <option value="cancelled">cancelled</option>
          <option value="expired">expired</option>
        </select>
        <button id="loadBtn">Load</button>
      </div>
      <div id="msg" class="error"></div>
    </div>

    <div id="list"></div>
  </div>

  <script src="/static/app.js"></script>
  <script>
    requireAuthOrRedirect();

    async function loadReservations() {
      const msg = document.getElementById("msg");
      const list = document.getElementById("list");
      msg.textContent = "";
      list.innerHTML = "";

      const statusVal = document.getElementById("status").value;
      const params = { page: 1, page_size: 20 };
      if (statusVal) params.status = statusVal;

      try {
        const data = await fetchReservations(params);
        data.items.forEach(r => {
          const div = document.createElement("div");
          div.className = "card";
          div.innerHTML = `
            <div class="row">
              <div style="flex:1;">
                <div><b>Reservation #${r.reservation_id}</b> <span class="badge">${r.status}</span></div>
                <small>Trip: ${r.trip_id}</small><br/>
                <small>Seats: ${r.seat_ids.join(", ")}</small><br/>
                <small>Created: ${r.created_at}</small>
              </div>
              <div>
                <button class="danger" data-id="${r.reservation_id}">Cancel</button>
              </div>
            </div>
          `;
          // اگر status active نبود، دکمه لغو را غیرفعال کن
          const btn = div.querySelector("button.danger");
          if (r.status !== "active") {
            btn.disabled = true;
            btn.style.opacity = "0.5";
          } else {
            btn.addEventListener("click", async () => {
              try {
                await cancelReservation(r.reservation_id);
                alert("Cancelled.");
                loadReservations();
              } catch (e) {
                msg.textContent = `${e.code}: ${e.message}`;
              }
            });
          }

          list.appendChild(div);
        });

      } catch (e) {
        msg.textContent = `${e.code}: ${e.message}`;
        if (e.status === 401) logout();
      }
    }

    document.getElementById("loadBtn").addEventListener("click", loadReservations);
    loadReservations();
  </script>
</body>
</html>